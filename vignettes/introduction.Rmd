---
title: "Introduction to the UrbanTempo package"
author: "Timothée Flutre and Marie Flutre"
date: "`r format(Sys.time(), '%d/%m/%Y %H:%M:%S')`"
colorlinks: true
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: TRUE
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: TRUE
vignette: >
  %\VignetteIndexEntry{Introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!--
setwd("~/src/UrbanTempo/vignettes/")

library(devtools)
build_vignettes()

library(rmarkdown)
render("introduction.Rmd", "html_document")
-->


# Preamble

This document is an [R](https://www.r-project.org/) vignette available under the [CC BY-SA 4.0](http://creativecommons.org/licenses/by-sa/4.0/) license.

It is part of the R package [UrbanTempo](https://github.com/marieflutre/UrbanTempo) (free software):
```{r load_pkg}
library(UrbanTempo)
```

For more details about free software, you can refer to the [information](https://www.gnu.org/philosophy/philosophy.en.html) provided by the [Free Software Foundation](https://en.wikipedia.org/wiki/Free_Software_Foundation).

The R chunk below is used to assess how much time it takes to execute the R code in this document (see the appendix at the end):
```{r time_0}
t0 <- proc.time()
```


# Context

Beyond the long-term processes of urbanization, daily urban practices contribute greatly to the production and continual adaptation of the urban fabric.
Methodologically, such an investigation can be carried out by means of Lefebvre’s "rhythmanalysis" (2004), which seeks to capture the everyday rhythms and dynamics of social life.
This methodology  developed in my PhD thesis (Gibert, 2014) is particularly relevant in Ho Chi Minh City urban context, where it reveals highly "polyrhythmic places" and neighborhoods.


# Show an example with fake data

## Create data

Let's create a minimal data set of two space types, with a total of one interval and two ponctual events over two hours, and save it into a file:
```{r fake_data_create}
tmpd <- tempdir() # temporary directory
input.df <- data.frame("date"=c("2017-04-23", "2017-04-23", "2017-04-23"),
                       "time"=c("07:24", "07:13", "08:17"),
                       "shops"=c("shop end", "shop start", NA),
                       "street"=c("hawker", NA, "hawker"),
                       stringsAsFactors=FALSE)
tmpf <- paste0(tmpd, "/input_temporalities.tsv") # temporary file
write.table(x=input.df, file=tmpf, quote=FALSE, sep="\t",
            row.names=FALSE, col.names=TRUE)
```

## Load data

Such a file can be loaded with the following function, whose output is here assigned to a variable named `tpr`:
```{r fake_data_load}
tpr <- readTemporalities(file=tmpf, duration.event=60, verbose=1)
```

More details are available in the help of this function, via `?readTemporalities`.

The set of unique temporality types per space type can be obtained via the following command:
```{r fake_data_uniq_tpr_types_per_space_type}
lapply(tpr, function(x){unique(x$id)})
```


## Plot data

First, we need to specify the appearance of each type of temporalities, such as their colors which can be chosen via a palette:

* http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf

* https://www.nceas.ucsb.edu/~frazier/RSpatialGuides/colorPaletteCheatsheet.pdf

```{r fake_data_app}
app <- list("shops"=data.frame(col="chocolate", row.names="shop"),
            "street"=data.frame(col="blueviolet", row.names="hawker"))
```

Then, the input temporalities contained in the `tpr` variable can be plotted with the following function:
```{r fake_data_plot, fig.width=8}
plotTemporalities(temporalities=tpr, appearances=app,
                  main="Fake example of urban temporalities",
                  data.source="fake example, 2017",
                  vertical.bars.per.hour=TRUE,
                  verbose=1)
```

More details are available in the help of this function, via `?plotTemporalities`.

If we want to save such a plot in, say, the [PDF](https://en.wikipedia.org/wiki/Portable_Document_Format) format, we can do it with the following commands:
```{r fake_data_plot_pdf, eval=FALSE}
pdf(file="plot_temporalities.pdf", width=7, height=4,
    title="Urban temporalities")
plotTemporalities(temporalities=tpr, appearances=app)
dev.off()
```

To add the legend, such a file can be edited with [Inkscape](https://inkscape.org) (free software) or Adobe Illustrator.


## Clean

Remove the temporary file:
```{r fake_data_clean}
if(file.exists(tmpf))
  file.remove(tmpf)
```


# Reproduce the figure from Gibert's PhD thesis (2014)

Retrieve the data from a file which is part of the UrbanTempo package:
```{r}
f <- system.file("extdata", "Gibert_2014_data-PhD-thesis.tsv",
                 package="UrbanTempo")
```

Load the data from this file (observations from 7am to 12pm):
```{r}
tpr <- readTemporalities(file=f)
```

Have a quick look at the data:
```{r}
lapply(tpr, function(x){unique(x$id)})
```

Choose the colors:
```{r}
app <- list(shops=data.frame(col=c("darkgrey", "orange", "darkorange1"),
                             row.names=c("closed", "preparing", "opened")),
            houses=data.frame(col=c("burlywood3", "darkgrey", "hotpink3"),
                              row.names=c("stalls", "cleaning", "social")),
            street=data.frame(col=c("darkmagenta", "darkslateblue", "orange", "cyan"),
                              row.names=c("hawker", "collector", "delivery", "beggar")))
```

Make the plot:
```{r, fig.width=15, fig.height=5}
plotTemporalities(temporalities=tpr, appearances=app,
                  main="Urban temporalities (alleyway 246 Xo Viet Nghe Tinh)",
                  data.source="M. Gibert, 08/08/2011")
```


# Appendix

Below are some details about this vignette:
```{r info}
t1 <- proc.time()
t1 - t0
print(sessionInfo(), locale=FALSE)
```
